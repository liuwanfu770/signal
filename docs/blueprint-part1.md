
# 《Signal-CLI 多账号管理系统》项目实施蓝图 - 第一部分

## 1. 项目概述

### 1.1 项目基本信息

| 项次 | 内容 |
|-----|-----|
| 项目名称 | Signal-CLI 多账号管理系统 |
| 项目目标 | 构建一个稳定、安全、可扩展的系统，支持管理多个 Signal 账号，实现消息收发、群组管理、联系人管理等功能，提供友好的管理界面和用户界面，并支持容器化部署。 |
| 目标用户 | - 管理员：负责账号注册、养号、续号、封控及系统监控。 <br> - 普通用户：使用分配的账号进行消息收发和日常聊天。 |
| 预期规模 | 支持管理 5000 个 Signal 账号，具备动态扩展能力。 |

### 1.2 项目范围

#### 1.2.1 功能需求
• 账号管理：支持账号的注册、登录、状态管理（在线/离线/连接中）、信息修改、删除、快速切换。  
• 消息管理：支持文本和多媒体消息的发送、接收、状态跟踪（发送中/已发送/已送达/已读）、撤回（若支持）、转发（若支持）。  
• 群组管理：支持群组的创建、加入、退出、信息管理、成员管理。  
• 联系人管理：支持联系人的添加、删除、信息查看、分组（可选）。  
• 搜索功能：支持搜索联系人、群组、消息，并将搜索信息存储到数据库。  
• Webhook 支持：接收 Signal-CLI 的消息通知并处理。  
• 防封策略：限流、延迟、IP 轮换等策略，降低账号被封风险。

#### 1.2.2 非功能需求
• 高可用性：系统支持多实例部署，单个实例故障不影响整体服务。  
• 可靠性：确保消息发送和接收的成功率达到 99.9%。  
• 可扩展性：支持动态增加 Signal-CLI 实例，适应账号数量增长。  
• 可维护性：模块化设计，便于代码维护和功能扩展。  
• 安全性：支持认证、授权、数据加密，确保用户数据安全。  
• 合规性：遵守目标地区的数据隐私法规。  
• 可移植性：支持容器化部署，可在不同云服务器上运行。  
• 可观察性：提供日志和监控功能，便于问题排查。  
• 易用性：提供直观的用户界面和管理界面。

#### 1.2.3 性能指标
| 指标          | 目标值       |
|---------------|--------------|
| 注册 TPS      | 10 次/秒     |
| 消息发送 TPS  | 50 次/秒     |
| 消息发送延迟  | < 500 毫秒   |
| 并发用户数    | 5000 用户    |
| 数据存储量    | 10 TB（长期目标） |

#### 1.2.4 安全需求
• 认证：使用 JWT（JSON Web Token）进行身份验证。  
• 授权：基于角色的访问控制（RBAC），区分管理员和普通用户权限。  
• 加密：用户密码使用 bcrypt，加密敏感数据（如搜索信息）使用 AES-256，传输使用 HTTPS。

#### 1.2.5 可选功能
• 与现有 CRM 系统集成。  
• 数据分析和 BI 功能。  
• UI/UX 优化。

---

## 2. 技术选型

| 类别      | 选型                  | 说明                                                                    |
|-----------|-----------------------|-------------------------------------------------------------------------|
| 后端语言  | Node.js (v18.x LTS)   | 异步 I/O 模型适合高并发，生态丰富，开发迅速。                            |
| 后端框架  | Express               | 轻量级、灵活，支持快速构建 REST API。                                   |
| 数据库    | PostgreSQL (16.x)     | 开源、支持高并发和 JSONB 数据类型，适合复杂查询。                       |
| HTTP 客户端 | Axios                | 轻量易用，用于调用 Signal-CLI REST API。                                 |
| 进程管理  | PM2                   | 保证后端进程稳定，支持热重载和负载均衡。                                 |
| 前端语言  | HTML/CSS/JavaScript   | 初期使用基础技术栈，后期可升级至 Vue.js 或 React。                       |
| 容器化    | Docker, Docker Compose | 实现服务快速部署、隔离和扩展，便于多实例管理。                           |
| 反向代理  | Nginx                 | 实现负载均衡、SSL 终止和跨域处理。                                       |
| 日志管理  | ELK (Elasticsearch, Logstash, Kibana) | 收集、存储、分析日志，提供可视化查询界面。               |
| 监控工具  | Prometheus, Grafana   | 监控系统指标，提供实时仪表盘。                                           |
| 安全工具  | JWT, bcrypt, AES-256, HTTPS | 实现身份验证、授权、数据加密和传输安全。                   |
| 版本控制  | Git                   | 代码版本管理，支持团队协作。                                             |
| 项目管理  | Jira, Confluence      | 任务管理和文档协作（可选，视团队规模）。                                 |

### 2.1 技术选型理由
• Node.js + Express：异步处理高并发，Express 提供简洁路由和中间件。  
• PostgreSQL：支持 JSONB（适合存储搜索结果和消息内容），高可靠性。  
• Docker：容器化隔离 Signal-CLI 实例，每个实例建议管理 50-100 个账号。  
• Nginx：进行负载均衡，将请求分配到不同实例。  
• ELK 和 Prometheus：提供日志与监控支持。  

---

## 3. 系统架构

### 3.1 架构层次
系统采用分层架构，确保职责清晰且易扩展。

| 层级       | 功能描述                                                       |
|------------|----------------------------------------------------------------|
| 表示层     | - 前端用户界面：Signal 聊天功能（账号登录、消息收发、联系人/群组管理）<br>- 控制界面：管理员监控系统状态、管理容器、配置参数 |
| 应用层     | - 后端 API：处理表示层请求，调用业务逻辑层并返回结果<br>- Webhook 接收器：接收来自 Signal-CLI 的消息通知 |
| 业务逻辑层 | - 实现账号注册、消息发送、群组创建等核心逻辑<br>- 防封策略（限流、延迟、IP 轮换） |
| 基础设施层 | - 提供数据库访问（PostgreSQL）、Signal-CLI 客户端调用、日志记录、监控指标采集等 |

### 3.2 架构图

```
+-------------------------+
|       表示层            |
| - 前端用户界面          |
| - 控制管理界面          |
+-------------------------+
          ↓ (HTTP/HTTPS)
+-------------------------+
|       应用层            |
| - 后端 API 服务         |
| - Webhook 接收器        |
+-------------------------+
          ↓ (逻辑调用)
+-------------------------+
|       业务逻辑层        |
| - 账号/消息/群组逻辑    |
| - 防封策略              |
+-------------------------+
          ↓ (数据访问)
+-------------------------+
|       基础设施层        |
| - PostgreSQL            |
| - Signal-CLI 实例       |
| - 日志 (ELK)            |
| - 监控 (Prometheus)     |
+-------------------------+
```

#### 架构特点
• 模块化：各层职责分离，便于维护和扩展。  
• 高可用：多实例部署，Nginx 负载均衡。  
• 安全性：HTTPS 传输，JWT 认证，数据加密。  

---

## 4. 模块划分

系统按功能划分为以下模块，每个模块独立开发，便于扩展维护。

| 模块名称       | 功能描述                                             |
|----------------|------------------------------------------------------|
| 账号管理模块   | 账号注册、登录、状态管理、信息修改、删除、快速切换。 |
| 消息管理模块   | 文本/多媒体消息的发送、接收、状态跟踪、撤回、转发。   |
| 群组管理模块   | 创建群组、加入、退出、信息管理、成员管理。           |
| 联系人管理模块 | 添加、删除、查看、分组（可选）。                     |
| 搜索模块       | 搜索联系人、群组、消息，将搜索信息存储到数据库。     |
| Webhook 模块   | 接收 Signal-CLI 的消息通知并处理。                   |
| 安全模块       | 认证、授权、数据加密和安全配置。                     |
| 监控模块       | 收集系统指标、监控系统状态。                         |
| 日志模块       | 记录和分析系统日志。                                 |
| 配置模块       | 集中管理系统配置信息（数据库连接、Signal-CLI URL 等）。|

### 4.1 模块间关系
• 账号管理模块 调用 安全模块 进行认证，调用 搜索模块 纪录注册搜索信息。  
• 消息管理模块 调用 Webhook 模块 接收通知，并调用数据库存储消息。  
• 监控模块 / 日志模块 与所有模块交互，收集系统指标与日志。  

---

## 5. 数据库设计

### 5.1 数据库选择
• 类型：PostgreSQL  
• 版本：16.x  
• 理由：高并发、支持 JSONB 数据类型，适合复杂查询。

### 5.2 表结构设计（示例）
• users：存储管理员和普通用户信息  
• signal_accounts：存储 Signal 账号信息  
• messages：存储消息内容  
• groups、group_members：存储群组及其成员  
• contacts：存储联系人信息  
• search_history：存储搜索记录  
• containers：存储 Signal-CLI 容器信息  

### 5.4 建表脚本
可在 /Users/bc/signal-project/sql/00-init.sql 中使用 CREATE TABLE 语句一次性创建。

---

## 6. API 设计

### 6.1 API 风格
• RESTful 风格，JSON 数据格式  
• 认证：JWT  
• 版本路径：/v1  
• 统一错误格式：包含错误代码与描述  

---
